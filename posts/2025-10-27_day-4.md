---
title: "Day 4: Data Preparation Pipeline for SNP-Seek"
description: Explains the workflow for transforming genomic datasets, including the conversion of VCF and PLINK files into HDF5 formats for integration into the database.
authorId: "riza"
published: 2025-10-27
---

### Input and Output

**Input:** Either a merged (multisample) VCF file or a PLINK file

**Output:**

- **HDF5 file** - encoding the genotype matrix
- **SNP positions text file** - CHR, POS, REF, ALT in the same order as rows in the HDF5 file
- **Sample IDs text file** - In the same order as columns in the HDF5 file

## The Two-Step Process

The data preparation involves two main steps:

1. **Convert VCF/PLINK to text matrix** - Using custom scripts with `awk` and/or `bcftools`
2. **Convert text matrix to HDF5** - Using a compiled C++ program for optimized storage

The **SNP positions** can be directly extracted from the text matrix file, while **sample list** retrieval differs between VCF and PLINK inputs.

## Text Matrix Format Specification

The text matrix follows a specific format with rows corresponding to SNPs. Here's an example matrix for the RICE-RP dataset:

![Screenshot of RICE-RP Matrix](public/assets/day-4/rice-rp-matrix.png)

The columns represent the following (from left to right):

- **CHR**: Chromosome number (not Chado)
- **POS**: 1-based position
- **REF**: Reference allele
- **ALT**: Alternate allele
- **Sample columns**: Diploid genotype calls (Sample1, Sample2, Sample3, etc.). Missing calls can be encoded with `00` or `..`.

## Case 1: Input is a Multisample VCF

> **Note:** The VCF should contain only SNP genotypes, no indels. Indels should be processed separately.

### Creating the Matrix File

Use `bcftools query` to extract genotype information:

```bash
bcftools query -f '%CHROM\t%POS\t%REF\t%ALT[\t%TGT]\n' input.vcf > matrix.txt
```

This extracts the "translated genotype" (TGT) (i.e. converts `0/0` to `A/A` and `0/1` to `A/G` if REF is A and ALT is G) and removes the slashes.

**Special cases to handle:**

- **Phased VCFs**: Convert `|` to `/` first
- **Non-numerical chromosomes**: SNP-Seek typically accepts only numerical chromosome names
- **Monomorphic SNPs**: If missing ALT alleles, generate the first 4 columns and genotype columns separately, edit the ALT column, then use `paste` to concatenate

### Creating the Sample List

Extract sample names from the VCF header using one of these methods:

**Method 1 - Manual extraction with awk:**

```bash
gunzip -c myfile.vcf.gz | awk '$1 ~/#CHR/ {print;} $1!~/#/{exit}' | tr "\t" "\n" | tail -n+10 > sample_list.txt
```

**Method 2 - Using bcftools view:**

```bash
bcftools view -h myfile.vcf.gz | grep "CHR" | tr "\t" "\n" | tail -n+10 > sample_list.txt
```

**Method 3 - Using bcftools query:**

```bash
bcftools query -f '[%SAMPLE\t]\n' myfile.vcf.gz | head -n1 | tr "\t" "\n" | tr -s "\n" > sample_list.txt
```

## Case 2: Input is a PLINK File

### Creating the Matrix File

The text matrix format is similar to PLINK's TPED (transposed PED) file, but with important differences: In PLINK, A1 (first allele) contains ALT and A2 contains REF - opposite order to VCF. We need to swap these columns, but first must ensure the PLINK file has the correct reference allele.

**Steps:**

1. **If you have PED/MAP dataset, convert it to binary format**

   ```bash
   plink --makebed ...
   ```

2. **If you have a `.bim` file, check correctness of reference allele** (using an R script [more context])

3. **Generate TPED file:**

   ```bash
   plink --bfile <original_file> --recode transpose
   ```

4. **Process TPED to create matrix (Use `awk` to remove `cM` column (#3) and swap `A1` and `A2`):**

   ```bash
   awk '{ $3=""; ref=$6; $6=$5; $5=ref; print $0;}' myfile.tped | \
   tr -s " " | tr " " "\t" > myfile.matrix
   ```

### Creating the Sample List

PLINK files contain two IDs per sample in the `.fam` or `.tfam` file:

- **FID**: Family ID
- **IID**: Individual ID

The full format is: `FID IID Father Mother Sex Phenotype`

What goes into the database is up to us - it just needs to be a unique ID.

**Example list creation strategies:**

**If FID = IID:**

In the 3K dataset, both FID and IID were set to the same IRIS ID, making sample extraction straightforward.

```bash
awk '{print $1}' original.tfam > sample_list.txt
# or
awk '{print $2}' original.tfam > sample_list.txt
```

**If FID = 0, use IID:**

```bash
awk '{print $2}' original.tfam > sample_list.txt
```

**If FID â‰  IID, you may combine both:**

```bash
awk '{print $1 "_" $2}' original.tfam > sample_list.txt
```

## Extracting Position List

The position list can be extracted directly from the matrix file:

```bash
cut -f1-4 mat_vcf.txt > pos.txt
```

> **Note:** Positions are 1-based in this format.

## Converting Text Matrix to HDF5

### Compilation

First, compile Roven's matrix conversion program:

```bash
g++ -o loadmatrix_geno loadmatrix_SNP.cpp -lhdf5
```

### Running the Conversion

Execute the compiled program on the text matrix:

**Syntax:**

```bash
./loadmatrix_geno -m <chunk_y> -n <chunk_x> -r <num_rows> -t -o <output_h5_file> -i <input_matrix_txt_file>
```

**Example:**

```bash
./loadmatrix_geno -m 5231 -n 20 -r 5231433 -t -o output.h5 -i matrix.txt
```

Some parameters are funny: -m and -n are "chunking" parameters for HDF5. Here is our "documentation":

```cpp
while((i=getopt(argc, argv, options)) != -1){
    switch(i){
        case 'm': CHUNK_Y = atoi(optarg); break;
        case 'n': CHUNK_X = atoi(optarg); break;
        case 'r': SAMCOUNT = atoi(optarg); break;  // NOT DOCUMENTED !!!
        case 't': is_transposed = true; break;
        case 'i': inputfile = optarg; break;
        case 'o': strcpy(output_file, optarg); break;
        default: break;
    }
}
```

In this case we divided the dataset into approximately 1000 chunks of 5231 SNPs each.  
These need to be tuned in a similar way for every new dataset.

- `-i`: input
- `-o`: output
- `-t`: transpose - for the text matrix as above we have to use it
- `-r`: number of rows (samples if no `-t`, or SNPs if `-t` is given)

> **Note:** The output file is only up to 200 characters in Roven's code (`static char output_file[200];`)

### Verification

Check the HDF5 file structure after creation:

```bash
h5ls output.h5
```

**Expected output**: Dataset {5231433, 4591}

**Format**: {SNPs, Samples} - SNPs as first index, samples as second index
